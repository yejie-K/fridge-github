## 目标
- 为智能冰箱管家接入云端数据库与后端服务，实现跨设备数据共享、安全鉴权与稳定持久化。
- 保持离线可用与乐观更新体验，现有 LocalStorage 作为离线缓存与回退方案。

## 方案对比
- Supabase（推荐）：托管 Postgres + 行级安全（RLS）+ 内置 Auth + Edge Functions，前端直接使用 SDK，集成快、维护成本低。
- Vercel Postgres + Serverless Functions：与现有 Vercel 部署高度融合，推荐搭配 Drizzle/Prisma，但需自建鉴权与 API，工程量较高。
- Firebase（Firestore）：实时能力强、前端集成简单，但查询与关系型建模受限；对本项目类别/统计的关系型需求不如 Postgres合适。

## 推荐架构（Supabase）
- 数据库：Supabase Postgres，开启 RLS。
- 鉴权：Supabase Auth（邮箱/短信/OAuth，或匿名设备 ID）。
- 前端：继续使用现有 React SPA；SDK 通过 [services/storage.ts](file:///Users/yyy/Desktop/智能冰箱管家/fridge-github/src/services/storage.ts) 抽象；状态逻辑集中在 [useFoodItems.ts](file:///Users/yyy/Desktop/智能冰箱管家/fridge-github/src/hooks/useFoodItems.ts)。
- 离线策略：LocalStorage 保存最近数据与未同步队列，联网后后台同步。

## 数据模型（初版）
- 表：food_items
  - id (uuid, pk)
  - user_id (uuid, 索引)
  - name (text)
  - quantity (int)
  - category (text)
  - entry_time (timestamptz)
  - expiry_time (timestamptz, nullable)
  - created_at (timestamptz, default now())
  - updated_at (timestamptz)
- 表：inventory_movements（可选，用于统计出入库）
  - id (uuid, pk), item_id (uuid), type ('in'|'out'), delta (int), at (timestamptz)
- RLS 策略：仅允许 user_id = auth.uid() 的用户读写各自数据。

## 实施步骤
### 环境与依赖
- 在 Supabase 控制台创建项目；获取 SUPABASE_URL、SUPABASE_ANON_KEY。
- 在 Vercel Project Settings 配置环境变量：SUPABASE_URL、SUPABASE_ANON_KEY（Preview/Production 分开设置）。
- 安装 SDK：项目已包含 @supabase/supabase-js（见 [package.json](file:///Users/yyy/Desktop/智能冰箱管家/fridge-github/package.json#L13-L26)）。

### 数据库与安全
- 在 Supabase SQL 编辑器创建表 food_items 与（可选）inventory_movements。
- 开启 RLS，并添加针对 food_items 的 SELECT/INSERT/UPDATE/DELETE 策略（auth.uid() 只能访问自己的数据）。

### 前端集成
- 新增 Supabase 客户端工厂（如 src/lib/supabase.ts），读取环境变量创建客户端。
- 改造 [services/storage.ts](file:///Users/yyy/Desktop/智能冰箱管家/fridge-github/src/services/storage.ts)：
  - 提供统一接口：list/create/update/delete，同步调用 Supabase；失败时写入离线队列。
- 改造 [useFoodItems.ts](file:///Users/yyy/Desktop/智能冰箱管家/fridge-github/src/hooks/useFoodItems.ts)：
  - 首次加载：优先拉取云端数据，回填到 LocalStorage；离线则用本地数据。
  - 新增/更新/删除：乐观更新 UI；后台同步云端，失败则标记重试。
- 保持解析与分类逻辑不变（见 [common.ts](file:///Users/yyy/Desktop/智能冰箱管家/fridge-github/src/utils/common.ts)）。

### 数据迁移（一次性）
- 使用现有 [backup.ts](file:///Users/yyy/Desktop/智能冰箱管家/fridge-github/src/services/backup.ts) 或新建迁移脚本：读取 LocalStorage 全量写入 Supabase（去重：name+entry_time）。
- 迁移完成后提示用户“数据已同步至云端”。

### 验证与发布
- 本地：
  - 使用 .env.local 注入 SUPABASE_URL/ANON_KEY 开发。
  - 执行 npm run build 验证无错误。
- 线上：
  - Preview/Prod 两次部署；分别验证登录、增删改查、离线回退与统计页。

## 验收标准
- 登录后的数据云端持久化，刷新与跨设备一致。
- 未登录可使用匿名设备 ID，但云端隔离；登录后数据归属用户。
- 离线操作可用，恢复联网后自动同步。
- 统计页数据来源云端，性能不低于当前版本。

## 可选替代方案
- Vercel Postgres + Drizzle：在项目内新增 api/ 目录实现 Serverless API；ORM 管理迁移；优点是强可控，缺点是工程量更大。
- Firebase Firestore：快速接入与实时订阅；如果后续需要复杂 SQL/统计，迁移成本较高。

## 风险与回滚
- 风险：网络不稳定导致用户体验波动。
- 缓解：保留 LocalStorage 缓存与未同步队列；提供“同步失败重试”提示。
- 回滚：通过特性开关切换回纯本地模式；不删除云端数据。

## 后续
- 确认采用 Supabase 后，我将：
  - 创建 SQL 脚本与 RLS 策略；
  - 添加 Supabase 客户端与服务实现；
  - 改造 useFoodItems 与 storage；
  - 编写迁移与同步脚本；
  - 配置 Vercel 环境变量并发布验证。